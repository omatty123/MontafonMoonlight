<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Workflow Automation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .workflow {
            padding: 30px;
        }

        .step {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .translation-editor {
            display: none;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .translation-pair {
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }

        .translation-pair:last-child {
            border-bottom: none;
        }

        .korean-text {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            color: #2d3748;
            line-height: 1.6;
        }

        .english-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            min-height: 60px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview code {
            display: block;
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“š Montafon Moonlight Chapter Automation</h1>
            <p>Streamlined workflow for weekly chapter translation and publishing</p>
        </header>

        <div class="workflow">
            <!-- Step 1: Input Korean Content -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Input Korean Content</div>
                </div>

                <div class="form-group">
                    <label for="koreanUrl">Korean Chapter URL (mediabuddha.net)</label>
                    <input type="url" id="koreanUrl" placeholder="http://www.mediabuddha.net/m/news/view.php?number=35373">
                </div>

                <div class="form-group">
                    <label for="koreanText">Or Paste Korean Text Directly</label>
                    <textarea id="koreanText" placeholder="Paste the Korean chapter text here..."></textarea>
                </div>

                <div class="button-group">
                    <button id="fetchBtn" onclick="fetchKoreanContent()">Fetch from URL</button>
                    <button id="parseBtn" onclick="parseKoreanText()">Parse Pasted Text</button>
                </div>

                <div id="step1Status" class="status-message"></div>
            </div>

            <!-- Step 2: Auto-Translate -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Auto-Translate</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">First-pass translation will be done automatically. You'll review and edit in the next step.</p>

                <button id="translateBtn" onclick="autoTranslate()" disabled>Start Auto-Translation</button>

                <div id="step2Status" class="status-message"></div>
            </div>

            <!-- Step 3: Review & Edit Translation -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Review & Edit Translation</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">Review the translation line-by-line. Edit for consistency in names, titles, and quality.</p>

                <div id="translationEditor" class="translation-editor"></div>

                <div id="step3Status" class="status-message"></div>
            </div>

            <!-- Step 4: Chapter Metadata -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Chapter Metadata</div>
                </div>

                <div class="form-group">
                    <label for="chapterNumber">Chapter Number</label>
                    <input type="text" id="chapterNumber" placeholder="20" value="">
                </div>

                <div class="form-group">
                    <label for="chapterTitle">Chapter Title</label>
                    <input type="text" id="chapterTitle" placeholder="Enter chapter title in English">
                </div>

                <div class="form-group">
                    <label for="chapterSlug">URL Slug</label>
                    <input type="text" id="chapterSlug" placeholder="chapter-title-slug">
                </div>

                <div class="form-group">
                    <label for="chapterDate">Publication Date</label>
                    <input type="date" id="chapterDate" value="">
                </div>

                <div class="form-group">
                    <label for="chapterSummary">Summary</label>
                    <textarea id="chapterSummary" placeholder="Brief summary of the chapter..." style="min-height: 80px;"></textarea>
                </div>

                <div class="form-group">
                    <label for="coverImage">Cover Image Path</label>
                    <input type="text" id="coverImage" placeholder="assets/ch20-cover.jpg">
                </div>

                <div class="form-group">
                    <label for="heroImage">Hero Image Path</label>
                    <input type="text" id="heroImage" placeholder="assets/ch20-hero.jpg">
                </div>

                <button onclick="autoFillSlug()">Auto-Generate Slug from Title</button>
            </div>

            <!-- Step 5: Generate Files -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Generate Files</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">Generate the chapter HTML file and JSON entry. Review before downloading.</p>

                <button id="generateBtn" onclick="generateFiles()" disabled>Generate Chapter Files</button>

                <div id="htmlPreview" class="preview hidden">
                    <h3 style="margin-bottom: 10px;">Chapter HTML Preview:</h3>
                    <code id="htmlCode"></code>
                </div>

                <div id="jsonPreview" class="preview hidden">
                    <h3 style="margin-bottom: 10px;">chapters.json Entry:</h3>
                    <code id="jsonCode"></code>
                </div>

                <div class="button-group" id="downloadButtons" style="display: none; margin-top: 20px;">
                    <button class="btn-success" onclick="downloadHTML()">Download Chapter HTML</button>
                    <button class="btn-success" onclick="copyJSON()">Copy JSON to Clipboard</button>
                </div>

                <div id="step5Status" class="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let koreanParagraphs = [];
        let translatedParagraphs = [];
        let chapterData = {};

        // Initialize with today's date and next chapter number
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('chapterDate').value = today;
            document.getElementById('chapterNumber').value = '20'; // Will be auto-detected
        });

        // Step 1: Fetch or parse Korean content
        async function fetchKoreanContent() {
            const url = document.getElementById('koreanUrl').value.trim();
            if (!url) {
                showStatus('step1Status', 'Please enter a URL', 'error');
                return;
            }

            showStatus('step1Status', 'Fetching content... (Note: May fail due to CORS. If so, copy/paste text instead)', 'info');

            // Save Korean URL
            chapterData.koreanLink = url;

            // Note: Direct fetching may fail due to CORS. User should paste text as fallback.
            showStatus('step1Status', 'Due to browser security, please copy the Korean text and paste it in the text area above, then click "Parse Pasted Text"', 'info');
        }

        function parseKoreanText() {
            const text = document.getElementById('koreanText').value.trim();
            if (!text) {
                showStatus('step1Status', 'Please paste Korean text', 'error');
                return;
            }

            // Split into paragraphs
            koreanParagraphs = text.split('\n').filter(p => p.trim().length > 0);

            showStatus('step1Status', `âœ“ Parsed ${koreanParagraphs.length} paragraphs`, 'success');
            document.getElementById('translateBtn').disabled = false;
        }

        // Step 2: Auto-translate
        async function autoTranslate() {
            if (koreanParagraphs.length === 0) {
                showStatus('step2Status', 'No content to translate', 'error');
                return;
            }

            showStatus('step2Status', 'Translating... This may take a moment.', 'info');
            document.getElementById('translateBtn').disabled = true;

            // Note: Using Google Translate via a simple approach
            // For production, you'd want to use a proper translation API
            translatedParagraphs = [];

            for (let i = 0; i < koreanParagraphs.length; i++) {
                const korean = koreanParagraphs[i];
                // Simple Google Translate redirect approach
                const translated = await translateText(korean);
                translatedParagraphs.push(translated);
            }

            showStatus('step2Status', `âœ“ Translated ${translatedParagraphs.length} paragraphs`, 'success');
            buildTranslationEditor();
            document.getElementById('generateBtn').disabled = false;
        }

        async function translateText(text) {
            // This is a placeholder. In real use, you'd want to:
            // 1. Use Google Cloud Translation API with your API key
            // 2. Or use a translation service
            // For now, we'll return a marker that user needs to edit
            return `[AUTO-TRANSLATION NEEDED] ${text}`;
        }

        // Step 3: Build translation editor
        function buildTranslationEditor() {
            const editor = document.getElementById('translationEditor');
            editor.innerHTML = '';
            editor.style.display = 'block';

            koreanParagraphs.forEach((korean, index) => {
                const pair = document.createElement('div');
                pair.className = 'translation-pair';

                pair.innerHTML = `
                    <div class="korean-text">${korean}</div>
                    <textarea class="english-input" data-index="${index}">${translatedParagraphs[index] || ''}</textarea>
                `;

                editor.appendChild(pair);
            });

            // Add event listeners to sync translations
            document.querySelectorAll('.english-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    translatedParagraphs[index] = e.target.value;
                });
            });
        }

        // Step 4: Auto-generate slug
        function autoFillSlug() {
            const title = document.getElementById('chapterTitle').value.trim();
            if (!title) return;

            const slug = title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();

            document.getElementById('chapterSlug').value = slug;
        }

        // Step 5: Generate files
        function generateFiles() {
            // Collect metadata
            const chapterNum = document.getElementById('chapterNumber').value.trim();
            const title = document.getElementById('chapterTitle').value.trim();
            const slug = document.getElementById('chapterSlug').value.trim();
            const date = document.getElementById('chapterDate').value.trim();
            const summary = document.getElementById('chapterSummary').value.trim();
            const cover = document.getElementById('coverImage').value.trim();
            const hero = document.getElementById('heroImage').value.trim();
            const koreanUrl = document.getElementById('koreanUrl').value.trim() || chapterData.koreanLink || '';

            // Validation
            if (!title || !slug || !date || !summary || !cover || !hero) {
                showStatus('step5Status', 'Please fill in all metadata fields', 'error');
                return;
            }

            if (translatedParagraphs.length === 0) {
                showStatus('step5Status', 'No translated content available', 'error');
                return;
            }

            // Generate HTML content
            const htmlContent = generateChapterHTML(translatedParagraphs);

            // Generate JSON entry
            const jsonEntry = {
                title: title,
                slug: slug,
                href: `chapter.html?slug=${slug}`,
                date: date,
                cover: cover,
                hero: hero,
                summary: summary,
                status: "published",
                contentHtml: `content/chapter-${chapterNum}.html`,
                koreanLink: koreanUrl
            };

            // Store for download
            chapterData.htmlContent = htmlContent;
            chapterData.jsonEntry = jsonEntry;
            chapterData.chapterNum = chapterNum;

            // Show previews
            document.getElementById('htmlCode').textContent = htmlContent;
            document.getElementById('jsonCode').textContent = JSON.stringify(jsonEntry, null, 2);
            document.getElementById('htmlPreview').classList.remove('hidden');
            document.getElementById('jsonPreview').classList.remove('hidden');
            document.getElementById('downloadButtons').style.display = 'flex';

            showStatus('step5Status', 'âœ“ Files generated successfully!', 'success');
        }

        function generateChapterHTML(paragraphs) {
            const paragraphsHtml = paragraphs
                .map(p => `  <p>${p}</p>`)
                .join('\n\n');

            return `<div class="gdoc">\n\n${paragraphsHtml}\n</div>\n`;
        }

        // Download functions
        function downloadHTML() {
            const filename = `chapter-${chapterData.chapterNum}.html`;
            const blob = new Blob([chapterData.htmlContent], { type: 'text/html' });
            downloadBlob(blob, filename);
            showStatus('step5Status', `âœ“ Downloaded ${filename}`, 'success');
        }

        function copyJSON() {
            const jsonText = JSON.stringify(chapterData.jsonEntry, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showStatus('step5Status', 'âœ“ JSON copied to clipboard! Paste it into chapters.json', 'success');
            });
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility functions
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
        }
    </script>
</body>
</html>
