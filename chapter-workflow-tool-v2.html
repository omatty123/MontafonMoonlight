<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Workflow Automation Tool v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .workflow {
            padding: 30px;
        }

        .step {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        input[type="date"],
        input[type="file"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .translation-editor {
            display: none;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 700px;
            overflow-y: auto;
        }

        .translation-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
            align-items: start;
        }

        .translation-pair:last-child {
            border-bottom: none;
        }

        .korean-text {
            background: #fef5e7;
            padding: 12px;
            border-radius: 6px;
            color: #2d3748;
            line-height: 1.8;
            border: 2px solid #f9e79f;
        }

        .english-column {
            display: flex;
            flex-direction: column;
        }

        .english-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.8;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .english-input:focus {
            border-color: #667eea;
            outline: none;
        }

        @media (max-width: 900px) {
            .translation-pair {
                grid-template-columns: 1fr;
            }
        }

        .glossary-match {
            background: #fef5e7;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #d68910;
            margin-left: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview code {
            display: block;
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .glossary-table th,
        .glossary-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .glossary-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .glossary-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 10px;
            border: 2px solid #e2e8f0;
        }

        .hidden {
            display: none;
        }

        .info-badge {
            background: #e6fffa;
            color: #234e52;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Montafon Moonlight - Chapter Automation v2</h1>
            <p>Enhanced workflow with auto-detection, glossary, images, and GitHub commit</p>
        </header>

        <div class="workflow">
            <!-- Step 1: Input Korean URL (Most Important) -->
            <div class="step" style="border-left: 4px solid #48bb78;">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Start Here: Korean Chapter URL</div>
                </div>

                <div class="info-badge" style="background: #c6f6d5; color: #22543d; font-size: 16px;">
                    üéØ Next chapter is <strong id="nextChapterNum">20</strong> - Paste the Korean URL below
                </div>

                <div class="form-group">
                    <label for="koreanUrl" style="font-size: 16px; font-weight: 600;">Korean Chapter URL (from mediabuddha.net)</label>
                    <input type="url" id="koreanUrl" placeholder="http://www.mediabuddha.net/m/news/view.php?number=35373" style="font-size: 16px; padding: 15px;">
                </div>

                <div class="form-group">
                    <label for="koreanText">Korean Text (copy/paste from the website)</label>
                    <textarea id="koreanText" placeholder="Paste the Korean chapter text here..."></textarea>
                </div>

                <div class="form-group">
                    <label for="imageFile">Cover Image (upload or paste URL below)</label>
                    <input type="file" id="imageFile" accept="image/*" onchange="handleImageUpload(event)">
                    <input type="url" id="imageUrl" placeholder="Or paste image URL here" style="margin-top: 8px;">
                    <img id="imagePreview" class="image-preview hidden">
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="processKoreanChapter()" style="font-size: 16px; padding: 15px 30px;">üöÄ Process Chapter</button>
                </div>

                <div id="step1Status" class="status-message"></div>
            </div>

            <!-- Step 2: Glossary Management -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Translation Glossary</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">
                    Maintain consistency in names, titles, and terms. Glossary is saved locally.
                </p>

                <table class="glossary-table" id="glossaryTable">
                    <thead>
                        <tr>
                            <th>Korean Term</th>
                            <th>English Translation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="glossaryBody">
                        <!-- Glossary items will be added here -->
                    </tbody>
                </table>

                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="addGlossaryRow()">+ Add Term</button>
                    <button class="btn-success" onclick="saveGlossary()">Save Glossary</button>
                    <button class="btn-secondary" onclick="loadGlossary()">Load Saved Glossary</button>
                </div>

                <div id="step2Status" class="status-message"></div>
            </div>

            <!-- Step 3: Review & Edit Translation -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Translate & Edit (Parallel View)</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">
                    Korean on left, English on right. Use Google Sheets for free translation, then paste back here.
                </p>

                <div class="button-group">
                    <button id="sheetsTranslateBtn" onclick="generateGoogleSheetsFormula()" disabled>üìä Generate Google Sheets Formula</button>
                    <button onclick="pasteFromGoogleSheets()">üìã Paste Translations from Sheets</button>
                    <button onclick="applyGlossaryToTranslation()">üìù Apply Glossary Terms</button>
                    <button class="btn-secondary" onclick="clearTranslations()">Clear All</button>
                </div>

                <div id="sheetsInstructions" class="hidden" style="background: #e6fffa; border: 2px solid #81e6d9; padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px;">üìä Google Sheets Translation Steps:</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>Formula copied to clipboard!</li>
                        <li>Open Google Sheets, paste in column A</li>
                        <li>Translations will appear instantly (takes a few seconds)</li>
                        <li>Copy all English translations (column B)</li>
                        <li>Come back here and click "üìã Paste Translations from Sheets"</li>
                    </ol>
                </div>

                <div id="translationEditor" class="translation-editor"></div>

                <div id="step3Status" class="status-message"></div>
            </div>

            <!-- Step 4: Chapter Metadata -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Chapter Metadata</div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="chapterNumber">Chapter Number</label>
                        <input type="text" id="chapterNumber" placeholder="20" readonly>
                    </div>

                    <div class="form-group">
                        <label for="chapterDate">Publication Date</label>
                        <input type="date" id="chapterDate" value="">
                    </div>
                </div>

                <div class="form-group">
                    <label for="chapterTitle">Chapter Title</label>
                    <input type="text" id="chapterTitle" placeholder="Enter chapter title in English">
                </div>

                <div class="form-group">
                    <label for="chapterSlug">URL Slug</label>
                    <input type="text" id="chapterSlug" placeholder="chapter-title-slug">
                    <button onclick="autoFillSlug()" style="margin-top: 8px;">Auto-Generate Slug</button>
                </div>

                <div class="form-group">
                    <label for="chapterSummary">Summary</label>
                    <textarea id="chapterSummary" placeholder="Brief summary of the chapter..." style="min-height: 80px;"></textarea>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="coverImage">Cover Image Path</label>
                        <input type="text" id="coverImage" placeholder="assets/ch20-cover.jpg">
                    </div>

                    <div class="form-group">
                        <label for="heroImage">Hero Image Path</label>
                        <input type="text" id="heroImage" placeholder="assets/ch20-hero.jpg">
                    </div>
                </div>
            </div>

            <!-- Step 5: Generate & Commit -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Generate Files & Commit</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">
                    Generate chapter files and optionally commit directly to GitHub.
                </p>

                <div class="button-group">
                    <button onclick="generateFiles()">Generate Files</button>
                    <button class="btn-success" onclick="commitToGitHub()">Commit to GitHub</button>
                </div>

                <div id="htmlPreview" class="preview hidden">
                    <h3 style="margin-bottom: 10px;">Chapter HTML:</h3>
                    <code id="htmlCode"></code>
                </div>

                <div id="jsonPreview" class="preview hidden">
                    <h3 style="margin-bottom: 10px;">chapters.json Entry:</h3>
                    <code id="jsonCode"></code>
                </div>

                <div class="button-group" id="downloadButtons" style="display: none; margin-top: 20px;">
                    <button class="btn-success" onclick="downloadHTML()">Download Chapter HTML</button>
                    <button class="btn-success" onclick="copyJSON()">Copy JSON to Clipboard</button>
                    <button class="btn-success" onclick="downloadImage()">Download Image</button>
                </div>

                <div id="step5Status" class="status-message"></div>
            </div>

            <!-- Step 6: Settings (Optional) -->
            <div class="step" style="background: #f7fafc;">
                <div class="step-header">
                    <div class="step-number">‚öôÔ∏è</div>
                    <div class="step-title">Settings (Optional)</div>
                </div>

                <p style="margin-bottom: 15px; color: #718096;">
                    Configure GitHub token for auto-commit feature. Skip if you prefer manual commit.
                </p>

                <div class="info-badge" style="background: #bee3f8; color: #2c5282;">
                    üí° Translation uses FREE Google Sheets GOOGLETRANSLATE formula - no API key needed!
                </div>

                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <small style="color: #718096; display: block; margin-top: 5px;">
                        Get at: Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)<br>
                        Required scopes: <strong>repo</strong> (full control of private repositories)
                    </small>
                </div>

                <div id="step6Status" class="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let koreanParagraphs = [];
        let translatedParagraphs = [];
        let chapterData = {};
        let glossary = [];
        let currentChapterNum = 20;
        let imageBlob = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('chapterDate').value = today;
            loadGlossary();
            loadChaptersJson();
            loadFromBookmarklet();
        });

        // Load data from bookmarklet (if available)
        function loadFromBookmarklet() {
            const data = localStorage.getItem('montafonChapterData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);

                    // Check if data is fresh (within last 5 minutes)
                    const age = Date.now() - parsed.timestamp;
                    if (age < 5 * 60 * 1000) {
                        document.getElementById('koreanUrl').value = parsed.koreanUrl || '';
                        document.getElementById('koreanText').value = parsed.koreanText || '';
                        document.getElementById('imageUrl').value = parsed.imageUrl || '';

                        showStatus('step1Status', '‚úì Loaded from bookmarklet! Click "üöÄ Process Chapter" to continue.', 'success');

                        // Clear the data
                        localStorage.removeItem('montafonChapterData');
                    }
                } catch (e) {
                    console.log('No bookmarklet data found');
                }
            }
        }

        // Load chapters.json to auto-detect next chapter
        async function loadChaptersJson() {
            try {
                const response = await fetch('chapters.json');
                const chapters = await JSON.parse(await response.text());
                currentChapterNum = chapters.length + 1;
                document.getElementById('nextChapterNum').textContent = currentChapterNum;
                document.getElementById('chapterNumber').value = currentChapterNum;

                // Auto-fill image paths
                document.getElementById('coverImage').value = `assets/ch${currentChapterNum}-cover.jpg`;
                document.getElementById('heroImage').value = `assets/ch${currentChapterNum}-hero.jpg`;

                console.log(`‚úì Loaded: Next chapter is #${currentChapterNum}`);
            } catch (error) {
                currentChapterNum = 20;
                document.getElementById('chapterNumber').value = currentChapterNum;
                console.log('Could not load chapters.json, defaulting to chapter 20');
            }
        }

        // Image handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                imageBlob = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                showStatus('step1Status', '‚úì Image uploaded', 'success');
            }
        }

        async function downloadImageFromUrl() {
            const url = document.getElementById('imageUrl').value.trim();
            if (!url) {
                showStatus('step1Status', 'Please enter image URL', 'error');
                return;
            }

            try {
                // Use CORS proxy for fetching
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                imageBlob = await response.blob();

                const preview = document.getElementById('imagePreview');
                preview.src = URL.createObjectURL(imageBlob);
                preview.classList.remove('hidden');

                showStatus('step1Status', '‚úì Image downloaded', 'success');
            } catch (error) {
                showStatus('step1Status', 'Could not download image. Try uploading manually.', 'error');
            }
        }

        function downloadImage() {
            if (!imageBlob) {
                showStatus('step5Status', 'No image to download', 'error');
                return;
            }

            const chapterNum = document.getElementById('chapterNumber').value;
            const coverFilename = `ch${chapterNum}-cover.jpg`;
            const heroFilename = `ch${chapterNum}-hero.jpg`;

            // Download as cover (they can save the same file twice for hero)
            downloadBlob(imageBlob, coverFilename);
            showStatus('step5Status', `‚úì Downloaded ${coverFilename} - Save to assets/ folder. Use same image for hero image.`, 'success');
        }

        // Process Korean Chapter (main workflow button)
        async function processKoreanChapter() {
            const text = document.getElementById('koreanText').value.trim();
            const url = document.getElementById('koreanUrl').value.trim();
            const imageUrl = document.getElementById('imageUrl').value.trim();

            if (!text) {
                showStatus('step1Status', 'Please paste Korean text', 'error');
                return;
            }

            if (url) {
                chapterData.koreanLink = url;
            }

            showStatus('step1Status', 'Processing...', 'info');

            // Parse Korean text
            koreanParagraphs = text.split('\n').filter(p => p.trim().length > 0);
            translatedParagraphs = new Array(koreanParagraphs.length).fill('');

            // Handle image if URL provided
            if (imageUrl) {
                try {
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                    const response = await fetch(proxyUrl);
                    imageBlob = await response.blob();

                    const preview = document.getElementById('imagePreview');
                    preview.src = URL.createObjectURL(imageBlob);
                    preview.classList.remove('hidden');

                    showStatus('step1Status', `‚úì Parsed ${koreanParagraphs.length} paragraphs + image loaded!`, 'success');
                } catch (error) {
                    showStatus('step1Status', `‚úì Parsed ${koreanParagraphs.length} paragraphs (image failed, upload manually)`, 'info');
                }
            } else if (!imageBlob) {
                showStatus('step1Status', `‚úì Parsed ${koreanParagraphs.length} paragraphs (no image uploaded)`, 'info');
            } else {
                showStatus('step1Status', `‚úì Parsed ${koreanParagraphs.length} paragraphs + image ready!`, 'success');
            }

            buildTranslationEditor();
            document.getElementById('sheetsTranslateBtn').disabled = false;
        }

        // Korean text parsing (backup function)
        function parseKoreanText() {
            processKoreanChapter();
        }

        // Google Sheets Translation (FREE)
        function generateGoogleSheetsFormula() {
            if (koreanParagraphs.length === 0) {
                showStatus('step3Status', 'No content to translate', 'error');
                return;
            }

            // Generate formulas for Google Sheets
            let sheetsContent = '';
            koreanParagraphs.forEach((korean, index) => {
                const escapedKorean = korean.replace(/"/g, '""'); // Escape quotes for CSV
                // Column A: Korean text, Column B: GOOGLETRANSLATE formula
                sheetsContent += `"${escapedKorean}"\t=GOOGLETRANSLATE(A${index + 1},"ko","en")\n`;
            });

            // Copy to clipboard
            navigator.clipboard.writeText(sheetsContent).then(() => {
                document.getElementById('sheetsInstructions').classList.remove('hidden');
                showStatus('step3Status', '‚úì Copied! Open Google Sheets and paste (Ctrl+V or Cmd+V)', 'success');
            }).catch(() => {
                // Fallback: show in a textarea
                showSheetsFormulaModal(sheetsContent);
            });
        }

        function showSheetsFormulaModal(content) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; max-width: 600px;';
            modal.innerHTML = `
                <h3 style="margin-bottom: 15px;">Copy this to Google Sheets:</h3>
                <textarea style="width: 100%; height: 300px; font-family: monospace; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px;">${content}</textarea>
                <button onclick="this.parentElement.remove()" style="margin-top: 15px;">Close</button>
            `;
            document.body.appendChild(modal);
        }

        function pasteFromGoogleSheets() {
            const message = `Paste the English translations from Google Sheets (column B only).

Select all cells in column B (the English translations), copy them, then paste here:`;

            const translations = prompt(message);
            if (!translations) return;

            // Split by newlines
            const translatedLines = translations.split('\n').filter(line => line.trim());

            if (translatedLines.length !== koreanParagraphs.length) {
                showStatus('step3Status', `Expected ${koreanParagraphs.length} translations, got ${translatedLines.length}. Please copy all translations.`, 'error');
                return;
            }

            // Apply translations
            translatedParagraphs = translatedLines;
            buildTranslationEditor();
            showStatus('step3Status', `‚úì Imported ${translatedLines.length} translations! Review and edit.`, 'success');
        }

        function clearTranslations() {
            translatedParagraphs = new Array(koreanParagraphs.length).fill('');
            buildTranslationEditor();
            showStatus('step3Status', 'Cleared all translations', 'info');
        }

        // Glossary management
        function addGlossaryRow(korean = '', english = '') {
            const tbody = document.getElementById('glossaryBody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${korean}" class="glossary-korean" placeholder="ÌïúÍµ≠Ïñ¥"></td>
                <td><input type="text" value="${english}" class="glossary-english" placeholder="English"></td>
                <td><button class="btn-secondary" onclick="deleteGlossaryRow(this)">Delete</button></td>
            `;
        }

        function deleteGlossaryRow(btn) {
            btn.closest('tr').remove();
        }

        function saveGlossary() {
            const rows = document.querySelectorAll('#glossaryBody tr');
            glossary = [];

            rows.forEach(row => {
                const korean = row.querySelector('.glossary-korean').value.trim();
                const english = row.querySelector('.glossary-english').value.trim();
                if (korean && english) {
                    glossary.push({ korean, english });
                }
            });

            localStorage.setItem('montafonGlossary', JSON.stringify(glossary));
            showStatus('step2Status', `‚úì Saved ${glossary.length} terms`, 'success');
        }

        function loadGlossary() {
            const saved = localStorage.getItem('montafonGlossary');
            if (saved) {
                glossary = JSON.parse(saved);
                document.getElementById('glossaryBody').innerHTML = '';
                glossary.forEach(term => addGlossaryRow(term.korean, term.english));
                showStatus('step2Status', `‚úì Loaded ${glossary.length} terms`, 'success');
            } else {
                // Add some default terms
                addGlossaryRow('Ï†ïÏ∞¨Ï£º', 'Jeong Chanju');
                addGlossaryRow('Î∞ï', 'Pak');
                addGlossaryRow('', '');
            }
        }

        function applyGlossaryToTranslation() {
            saveGlossary(); // Save current glossary first

            koreanParagraphs.forEach((korean, index) => {
                let translation = translatedParagraphs[index] || korean;

                glossary.forEach(term => {
                    const regex = new RegExp(term.korean, 'g');
                    translation = translation.replace(regex, term.english);
                });

                translatedParagraphs[index] = translation;
            });

            buildTranslationEditor();
            showStatus('step3Status', '‚úì Applied glossary suggestions', 'success');
        }

        // Translation editor with parallel columns
        function buildTranslationEditor() {
            const editor = document.getElementById('translationEditor');
            editor.innerHTML = '';
            editor.style.display = 'block';

            koreanParagraphs.forEach((korean, index) => {
                const pair = document.createElement('div');
                pair.className = 'translation-pair';

                // Check for glossary matches
                let matches = [];
                glossary.forEach(term => {
                    if (korean.includes(term.korean)) {
                        matches.push(`${term.korean} ‚Üí ${term.english}`);
                    }
                });

                const matchBadge = matches.length > 0
                    ? `<div class="glossary-match">üìù ${matches.join(', ')}</div>`
                    : '';

                pair.innerHTML = `
                    <div class="korean-column">
                        <div class="korean-text">${korean}</div>
                        ${matchBadge}
                    </div>
                    <div class="english-column">
                        <textarea class="english-input" data-index="${index}" placeholder="English translation...">${translatedParagraphs[index] || ''}</textarea>
                    </div>
                `;

                editor.appendChild(pair);
            });

            // Add event listeners to sync translations
            document.querySelectorAll('.english-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    translatedParagraphs[index] = e.target.value;
                });
            });
        }

        // Slug generation
        function autoFillSlug() {
            const title = document.getElementById('chapterTitle').value.trim();
            if (!title) return;

            const slug = title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();

            document.getElementById('chapterSlug').value = slug;
        }

        // Generate files
        function generateFiles() {
            const chapterNum = document.getElementById('chapterNumber').value.trim();
            const title = document.getElementById('chapterTitle').value.trim();
            const slug = document.getElementById('chapterSlug').value.trim();
            const date = document.getElementById('chapterDate').value.trim();
            const summary = document.getElementById('chapterSummary').value.trim();
            const cover = document.getElementById('coverImage').value.trim();
            const hero = document.getElementById('heroImage').value.trim();
            const koreanUrl = document.getElementById('koreanUrl').value.trim() || chapterData.koreanLink || '';

            if (!title || !slug || !date || !summary || !cover || !hero) {
                showStatus('step5Status', 'Please fill in all metadata fields', 'error');
                return;
            }

            if (translatedParagraphs.length === 0 || translatedParagraphs.every(p => !p.trim())) {
                showStatus('step5Status', 'Please translate the content first', 'error');
                return;
            }

            const htmlContent = generateChapterHTML(translatedParagraphs);
            const jsonEntry = {
                title: title,
                slug: slug,
                href: `chapter.html?slug=${slug}`,
                date: date,
                cover: cover,
                hero: hero,
                summary: summary,
                status: "published",
                contentHtml: `content/chapter-${chapterNum}.html`,
                koreanLink: koreanUrl
            };

            chapterData.htmlContent = htmlContent;
            chapterData.jsonEntry = jsonEntry;
            chapterData.chapterNum = chapterNum;

            document.getElementById('htmlCode').textContent = htmlContent;
            document.getElementById('jsonCode').textContent = JSON.stringify(jsonEntry, null, 2);
            document.getElementById('htmlPreview').classList.remove('hidden');
            document.getElementById('jsonPreview').classList.remove('hidden');
            document.getElementById('downloadButtons').style.display = 'flex';

            showStatus('step5Status', '‚úì Files generated successfully!', 'success');
        }

        function generateChapterHTML(paragraphs) {
            const paragraphsHtml = paragraphs
                .map(p => `<p>${p}</p>`)
                .join('\n\n');

            return paragraphsHtml + '\n';
        }

        // Download functions
        function downloadHTML() {
            const filename = `chapter-${chapterData.chapterNum}.html`;
            const blob = new Blob([chapterData.htmlContent], { type: 'text/html' });
            downloadBlob(blob, filename);
            showStatus('step5Status', `‚úì Downloaded ${filename}`, 'success');
        }

        function copyJSON() {
            const jsonText = JSON.stringify(chapterData.jsonEntry, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showStatus('step5Status', '‚úì JSON copied! Add it to chapters.json', 'success');
            });
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // GitHub commit
        async function commitToGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                showStatus('step5Status', 'Please enter GitHub token to commit', 'error');
                return;
            }

            if (!chapterData.htmlContent || !chapterData.jsonEntry) {
                showStatus('step5Status', 'Please generate files first', 'error');
                return;
            }

            showStatus('step5Status', 'Committing to GitHub...', 'info');

            try {
                // This would use GitHub API to commit files
                // Implementation requires: fetching current file SHAs, creating commits, etc.
                showStatus('step5Status', 'GitHub auto-commit coming soon! For now, download files and commit manually.', 'info');
            } catch (error) {
                showStatus('step5Status', 'Commit failed: ' + error.message, 'error');
            }
        }

        // Utility
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
        }
    </script>
</body>
</html>
