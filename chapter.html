<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter • Moonlight of Montafon</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <style>
    body, h1, h2, h3, h4, h5, h6, p, a, span, li, nav, div {
      font-family: 'Inter', sans-serif !important;
    }
    .chapter-content p { margin: 1em 0; line-height: 1.7; }
    .chapter-image {
      max-width: 380px; width: 100%; height: auto;
      display: block; margin: 1.5rem auto;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div>
        <h1 class="font-bold text-2xl text-blue-600">
          <i class="fas fa-book mr-2"></i> Moonlight of Montafon
        </h1>
        <p class="text-sm text-gray-500">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border text-gray-600" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-4 text-sm text-gray-500">
    <a href="index.html" class="text-blue-600 hover:underline">Home</a> ›
    <span id="crumbTitle">Chapter</span>
  </nav>

  <!-- Chapter -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 id="chapterTitle" class="text-3xl font-bold mb-4">Loading…</h2>
    <div class="text-sm text-gray-500 mb-6">
      <span><i class="fas fa-calendar mr-1"></i><time id="pubDate">—</time></span>
      <span class="ml-4"><i class="fas fa-clock mr-1"></i><span id="readTime">—</span></span>
      <span class="ml-4"><i class="fas fa-eye mr-1"></i><span id="wordCount">—</span></span>
    </div>

    <figure id="heroBlock" class="mb-6 hidden">
      <img id="heroImg" src="" alt="Chapter image" class="chapter-image">
      <figcaption id="heroCaption" class="text-xs text-gray-500 text-center mt-2"></figcaption>
    </figure>

    <article id="contentRoot" class="chapter-content"></article>

    <!-- Prev/Next -->
    <nav class="mt-10 flex justify-between text-blue-600">
      <a id="prevLink" href="index.html" class="hover:underline"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="hover:underline">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>
  </main>

  <!-- Footer -->
  <footer class="border-t py-8 text-center text-sm text-gray-500">
    <p>Translation © 2025 • <a href="#" class="text-blue-600 hover:underline">Support the original author</a></p>
  </footer>

  <!-- Chapter Loader -->
  <script>
    const fmtLong = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    const num = n => (n||0).toLocaleString();

    async function loadChapters(){ const r = await fetch('chapters.json',{cache:'no-store'}); return r.ok? r.json():[]; }
    async function loadHtml(url){ const r = await fetch(url,{cache:'no-store'}); return r.ok? r.text():""; }

    (async function(){
      const list = await loadChapters();
      list.sort((a,b)=> new Date(a.date)-new Date(b.date));
      const slug = new URLSearchParams(location.search).get("slug");
      let idx = list.findIndex(c=>c.slug===slug); if(idx<0) idx=0;
      const ch = list[idx];

      document.getElementById("chapterTitle").textContent = ch.title;
      document.getElementById("crumbTitle").textContent = ch.title;
      document.getElementById("pubDate").textContent = fmtLong(ch.date);
      document.getElementById("readTime").textContent = "~"+ch.readTime+" min";
      document.getElementById("wordCount").textContent = num(ch.words)+" words";

      if(ch.hero){
        const f=document.getElementById("heroBlock");
        f.classList.remove("hidden");
        document.getElementById("heroImg").src = ch.hero;
        document.getElementById("heroCaption").textContent = ch.caption||"";
      }
      if(ch.contentHtml){
        const html = await loadHtml(ch.contentHtml);
        document.getElementById("contentRoot").innerHTML = html;
      }

      const prev = list[idx-1], next = list[idx+1];
      const prevEl=document.getElementById("prevLink"), nextEl=document.getElementById("nextLink");
      if(prev){ prevEl.href=prev.href; prevEl.textContent="‹ "+prev.title; }
      if(next){ nextEl.href=next.href; nextEl.textContent=next.title+" ›"; }
    })();
  </script>

  <!-- Theme toggle -->
  <script>
  (function () {
    const KEY = "theme";
    const root = document.documentElement;
    const btn  = document.getElementById("theme-toggle");

    function apply(mode){ 
      mode==="dark" ? root.setAttribute("data-theme","dark")
                    : root.removeAttribute("data-theme");
    }

    function current(){
      const saved = localStorage.getItem(KEY);
      if (saved==="light"||saved==="dark") return saved;
      return matchMedia("(prefers-color-scheme: dark)").matches ? "dark":"light";
    }

    let mode = current();
    apply(mode);

    if (btn){
      const flipIcon = () => {
        const i = btn.querySelector("i");
        if (!i) return;
        i.classList.toggle("fa-moon", mode==="light");
        i.classList.toggle("fa-sun",  mode==="dark");
      };
      flipIcon();
      btn.addEventListener("click", () => {
        mode = mode==="dark" ? "light":"dark";
        localStorage.setItem(KEY, mode);
        apply(mode);
        flipIcon();
      });
    }
  })();
  </script>
</body>
</html>
