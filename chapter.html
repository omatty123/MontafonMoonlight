<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter • Moonlight of Montafon</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root { --primary:#2563eb; --secondary:#64748b; --text:#1f2937; --bg:#ffffff; --border:#e5e7eb; --accent:#f3f4f6; }
    [data-theme="dark"] { --primary:#3b82f6; --secondary:#94a3b8; --text:#f9fafb; --bg:#111827; --border:#374151; --accent:#1f2937; }
    body { font-family:'Crimson Text', serif; color:var(--text); background:var(--bg); transition: background .2s, color .2s; }
    .ui { font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    .chapter-content { text-align: justify; }
    .chapter-content p { margin:1rem 0; line-height:1.8; font-size:1.12rem; }
    .translator-note { border-left: 4px solid var(--primary); background:var(--accent); padding: 1rem 1.25rem; margin: 1.5rem 0; border-radius: 0 .5rem .5rem 0; }
    .progress-bar { width:0%; transition: width .2s ease; }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-50" style="background:var(--bg); border-bottom:1px solid var(--border);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex items-center justify-between">
        <div class="min-w-0">
          <h1 class="text-xl sm:text-2xl font-bold ui" style="color: var(--primary);"><i class="fas fa-book mr-2"></i> <a href="index.html" class="hover:underline" style="color: var(--primary);">Moonlight of Montafon</a></h1>
          <p class="text-xs sm:text-sm ui" style="color: var(--secondary);">Translated from Korean • Updates weekly</p>
        </div>
        <div class="flex items-center space-x-3">
          <div class="ui text-xs sm:text-sm" style="color: var(--secondary);">Progress: <span id="reading-progress">0%</span></div>
          <button id="theme-toggle" class="p-2 rounded ui" style="background: var(--accent);" aria-label="Toggle theme"><i class="fas fa-moon" style="color: var(--text);"></i></button>
        </div>
      </div>
    </div>
    <div class="w-full h-1 bg-gray-200"><div id="progress-bar" class="progress-bar h-1" style="background: var(--primary);"></div></div>
  </header>

  <main id="main" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <nav class="ui text-sm mb-4" style="color: var(--secondary);" aria-label="Breadcrumb">
      <ol class="flex flex-wrap items-center gap-2">
        <li><a href="index.html" class="hover:underline" style="color: var(--primary);">Home</a></li>
        <li aria-hidden="true">›</li>
        <li aria-current="page" id="crumbTitle">Chapter</li>
      </ol>
    </nav>

    <header class="mb-6">
      <h2 id="chapterTitle" class="text-3xl font-bold mb-2">Loading…</h2>
      <div class="flex flex-wrap items-center gap-x-6 gap-y-2 ui text-sm" style="color: var(--secondary);">
        <span><i class="fas fa-calendar mr-1"></i><time id="pubDate" datetime="">—</time></span>
        <span><i class="fas fa-clock mr-1"></i><span id="readTime">—</span></span>
        <span><i class="fas fa-eye mr-1"></i><span id="wordCount">—</span></span>
      </div>
    </header>

    <figure class="mb-6" id="heroBlock" hidden>
      <img id="heroImg" src="" alt="Chapter image" class="w-full rounded-lg shadow" />
      <figcaption id="heroCaption" class="ui text-xs mt-2" style="color: var(--secondary);"></figcaption>
    </figure>

    <article id="contentRoot" class="chapter-content"></article>

    <aside class="translator-note ui rounded" role="note">
      <h3 class="font-bold mb-2" style="color: var(--text);"><i class="fas fa-sticky-note mr-2" style="color: var(--primary);"></i>Translator note</h3>
      <p class="text-sm">All-new story text loaded per chapter.</p>
    </aside>

    <nav class="mt-10 flex items-center justify-between ui">
      <a id="prevLink" href="index.html" class="text-sm hover:underline" style="color: var(--primary);"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="text-sm hover:underline" style="color: var(--primary);">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>

    <footer class="border-t mt-12 pt-6" style="border-color: var(--border);">
      <div class="text-center">
        <p class="ui mb-3" style="color: var(--secondary);">Translation © <span id="copyrightYear">2025</span></p>
      </div>
    </footer>
  </main>

  <script>
    // Theme toggle
    (function(){
      const btn=document.getElementById('theme-toggle'); const root=document.documentElement;
      const saved=localStorage.getItem('theme')||'light'; if(saved==='dark') root.setAttribute('data-theme','dark');
      btn.addEventListener('click', ()=>{ const isDark=root.getAttribute('data-theme')==='dark'; if(isDark){root.removeAttribute('data-theme'); localStorage.setItem('theme','light');} else {root.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark');} });
    })();

    // Date helpers
    function parseDateLocal(iso) {
      const [y, m, d] = iso.split('-').map(Number);
      return new Date(y, m - 1, d);
    }
    function fmtLong(iso) {
      return parseDateLocal(iso).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    }
    const num=(n)=> (n||0).toLocaleString();

    async function loadChapters(){ try{ const r=await fetch('chapters.json',{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); } catch(e){ return []; } }
    async function loadHtml(url){ try{ const r=await fetch(url,{cache:'no-store'}); return r.ok ? (await r.text()) : ''; } catch(e){ return ''; } }

    (async function(){
      const list = await loadChapters();
      list.sort
