<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"/>
  <title>Chapter • Moonlight of Montafon</title>

  <!-- Fonts / Tailwind / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <!-- Site theme (colors, image sizing, sticky header tokens, etc.) -->
  <link rel="stylesheet" href="assets/theme.css" />

  <style>
    /* Keep typography consistent with index */
    body, h1, h2, h3, h4, h5, h6, p, a, span, li, nav, div {
      font-family: 'Inter', sans-serif !important;
    }

    /* Layout */
    .chapter-wrap { max-width: 820px; margin: 0 auto; padding: 1.25rem; }
    .meta { color: var(--muted); }
    .chapter-title { font-size: 1.875rem; font-weight: 700; margin-bottom: .25rem; }

    /* Google Docs paste area: spacing + italics preserved */
    .gdoc p { margin: 1em 0; line-height: 1.75; }
    .gdoc em, .gdoc i { font-style: italic; }

    /* Optional hero image (sized in theme.css too) */
    #heroBlock[hidden]{ display:none; }

    /* Progress bar track adopts theme in theme.css; width driven via JS */
    .progress-rail { height: 4px; background: #e5e7eb; }
    html[data-theme="dark"] .progress-rail { background: #1f2937; }
    #progress { height: 4px; background: #3b82f6; width: 0%; transition: width .2s linear; }
  </style>
</head>
<body>

  <!-- Header (sticky via theme.css .stickybar helper) -->
  <header class="stickybar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="min-w-0">
        <h1 class="font-bold text-2xl" style="color:#3b82f6;">
          <i class="fas fa-book mr-2"></i>
          <a href="index.html" class="hover:underline" style="color:#3b82f6;">Moonlight of Montafon</a>
        </h1>
        <p class="text-sm meta">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border meta" aria-label="Toggle theme" title="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
    <div class="progress-rail"><div id="progress"></div></div>
  </header>

  <!-- Main -->
  <main class="chapter-wrap">
    <!-- Breadcrumb -->
    <nav class="text-sm meta mb-3" aria-label="Breadcrumb">
      <a href="index.html" class="hover:underline">Home</a> <span aria-hidden="true">›</span>
      <span id="crumbTitle">Chapter</span>
    </nav>

    <!-- Title + meta -->
    <header class="mb-4">
      <h2 id="chapterTitle" class="chapter-title">Loading…</h2>
      <div class="text-sm meta flex flex-wrap gap-x-6 gap-y-2">
        <span><i class="fas fa-calendar mr-1"></i><time id="pubDate" datetime="">—</time></span>
        <span><i class="fas fa-clock mr-1"></i><span id="readTime">—</span></span>
        <span><i class="fas fa-eye mr-1"></i><span id="wordCount">—</span></span>
      </div>
    </header>

    <!-- Optional hero -->
    <figure id="heroBlock" hidden class="mb-6">
      <img id="heroImg" src="" alt="Chapter image">
      <figcaption id="heroCaption" class="caption text-center"></figcaption>
    </figure>

    <!-- Chapter body (we inject HTML here) -->
    <article id="contentRoot" class="gdoc"></article>

    <!-- Prev / Next -->
    <nav class="mt-10 flex items-center justify-between text-sm">
      <a id="prevLink" href="index.html" class="hover:underline"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="hover:underline">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>

    <footer class="border-t mt-10 pt-5" style="border-color: var(--border);">
      <p class="text-center text-sm meta">Translation © <span id="copyYear"></span></p>
    </footer>
  </main>

  <!-- Scripts -->
  <script>
    // THEME — identical to index.html (shared via localStorage)
    (function () {
      const STORAGE_KEY = "theme";   // "light" | "dark"
      const root = document.documentElement;
      const btn  = document.getElementById("theme-toggle");

      function apply(theme){
        if(theme==="dark"){ root.setAttribute("data-theme","dark"); }
        else { root.removeAttribute("data-theme"); }
      }
      function initial(){
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved==="dark"||saved==="light") return saved;
        return matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      }
      function reflect(theme){
        if(!btn) return;
        btn.setAttribute("aria-pressed", theme==="dark" ? "true" : "false");
        btn.title = theme==="dark" ? "Switch to light mode" : "Switch to dark mode";
        const icon = btn.querySelector("i");
        if(icon){ icon.className = theme==="dark" ? "fas fa-sun" : "fas fa-moon"; }
      }
      let current = initial();
      apply(current); reflect(current);
      const mq = matchMedia("(prefers-color-scheme: dark)");
      function onSystem(e){
        if(localStorage.getItem(STORAGE_KEY)) return;
        current = e.matches ? "dark" : "light"; apply(current); reflect(current);
      }
      mq.addEventListener?.("change", onSystem);
      btn?.addEventListener("click", () => {
        current = current==="dark" ? "light" : "dark";
        localStorage.setItem(STORAGE_KEY, current);
        apply(current); reflect(current);
      });
    })();

    // UTIL
    const fmtLong = (d) => new Date(d).toLocaleDateString(undefined,{year:"numeric",month:"long",day:"numeric"});
    const num = (n) => (n||0).toLocaleString();
    async function loadChapters(){
      try{ const r = await fetch("chapters.json",{cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); }
      catch(e){ return []; }
    }
    async function loadHtml(url){
      try{ const r = await fetch(url,{cache:"no-store"}); return r.ok ? (await r.text()) : ""; }
      catch(e){ return ""; }
    }

    (async function main(){
      document.getElementById("copyYear").textContent = new Date().getFullYear();

      const list = await loadChapters();
      list.sort((a,b)=> new Date(a.date) - new Date(b.date)); // ascending 1→2→3

      const slug = new URLSearchParams(location.search).get("slug");
      let idx = list.findIndex(c=>c.slug===slug);
      if(idx<0) idx = 0;
      const ch = list[idx] || {};

      // Title + meta
      document.getElementById("chapterTitle").textContent = ch.title || "Chapter";
      document.getElementById("crumbTitle").textContent = ch.title || "Chapter";
      if(ch.date){
        const d = new Date(ch.date);
        const el = document.getElementById("pubDate");
        el.dateTime = d.toISOString().slice(0,10);
        el.textContent = fmtLong(ch.date);
      }
      document.getElementById("readTime").textContent = ch.readTime ? `~${ch.readTime} minutes` : "—";
      document.getElementById("wordCount").textContent = ch.words ? `${num(ch.words)} words` : "—";

      // Hero (optional)
      if(ch.hero){
        const fig = document.getElementById("heroBlock");
        fig.hidden = false;
        document.getElementById("heroImg").src = ch.hero;
        document.getElementById("heroCaption").textContent = ch.caption || "";
      }

      // Load chapter body
      let html = "";
      if(ch.contentHtml) html = await loadHtml(ch.contentHtml);
      document.getElementById("contentRoot").innerHTML = html || "<p>Chapter content coming soon.</p>";

      // Strip inline sizes from pasted GDocs images so CSS sizing wins
      document.querySelectorAll("#contentRoot img").forEach(img=>{
        img.removeAttribute("width"); img.removeAttribute("height");
        if(img.style){
          img.style.width=""; img.style.height=""; img.style.maxWidth="";
        }
      });

      // Prev / Next
      const prev = list[idx-1], next = list[idx+1];
      const prevEl = document.getElementById("prevLink");
      const nextEl = document.getElementById("nextLink");
      if(prev){ prevEl.href = prev.href || ("chapter.html?slug="+encodeURIComponent(prev.slug)); prevEl.innerHTML = `<i class="fas fa-arrow-left mr-2"></i>${prev.title}`; }
      else { prevEl.href = "index.html"; prevEl.innerHTML = `<i class="fas fa-arrow-left mr-2"></i>Home`; }
      if(next){ nextEl.href = next.href || ("chapter.html?slug="+encodeURIComponent(next.slug)); nextEl.innerHTML = `${next.title}<i class="fas fa-arrow-right ml-2"></i>`; }
      else { nextEl.href = "index.html"; nextEl.innerHTML = `Index<i class="fas fa-arrow-right ml-2"></i>`; }

      // Reading progress
      const bar = document.getElementById("progress");
      function up(){
        const s = document.documentElement.scrollTop || document.body.scrollTop;
        const h = (document.documentElement.scrollHeight - document.documentElement.clientHeight) || 1;
        const pct = Math.round(s / h * 100);
        bar.style.width = pct + "%";
      }
      window.addEventListener("scroll", up, {passive:true}); up();
    })();
  </script>
</body>
</html>
