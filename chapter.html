<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter • Moonlight of Montafon</title>

  <!-- Fonts identical to landing page -->
  <link rel="stylesheet" href="assets/fonts.css">
  <!-- Sticky header + gdoc fixes -->
  <link rel="stylesheet" href="assets/chapter.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
</head>
<body>

  <!-- Header (same look; now sticky) -->
  <header class="site-header">
    <div class="main-wrap" style="padding-top:14px;padding-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
        <div>
          <div class="brand" style="font-weight:800;font-size:1.35rem;color:#1d4ed8;">Moonlight of Montafon</div>
          <div style="color:#6b7280;font-size:.95rem;">Translated from Korean • Updates weekly</div>
        </div>
        <button id="theme-toggle" class="ui" aria-label="Toggle theme" style="padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="main-wrap">
    <!-- Breadcrumb -->
    <nav class="meta" aria-label="Breadcrumb" style="margin-bottom:10px;">
      <a href="index.html" style="color:#2563eb;text-decoration:none;">Home</a>
      <span aria-hidden="true">›</span>
      <span id="crumb">Chapter</span>
    </nav>

    <!-- Title -->
    <h1 id="title" class="title">Loading…</h1>

    <!-- Meta line -->
    <div class="meta" style="margin-bottom:14px;">
      <span><i class="fas fa-calendar"></i><time id="pubDate">—</time></span>
      <span><i class="fas fa-clock"></i><span id="readTime">—</span></span>
      <span><i class="fas fa-eye"></i><span id="wordCount">—</span></span>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0 18px;">

    <!-- HERO (now actually rendered) -->
    <figure id="hero" class="figure-hero" hidden>
      <img id="heroImg" alt="">
      <figcaption id="heroCap"></figcaption>
    </figure>

    <!-- Content root (we inject your DOCX->HTML fragment here) -->
    <article id="content" class="gdoc"></article>

    <!-- Prev / Next -->
    <nav class="meta" style="justify-content:space-between;margin-top:28px;">
      <a id="prev" href="index.html" style="color:#2563eb;text-decoration:none;"><i class="fas fa-arrow-left"></i> Previous</a>
      <a id="next" href="index.html" style="color:#2563eb;text-decoration:none;">Next <i class="fas fa-arrow-right"></i></a>
    </nav>

    <footer style="margin-top:32px;color:#6b7280;">Translation © <span id="year"></span></footer>
  </main>

  <script>
    // --- Sticky offset: measure header and set --hdr ---
    function setHdr() {
      const h = document.querySelector('.site-header')?.offsetHeight || 64;
      document.documentElement.style.setProperty('--hdr', h + 'px');
    }
    window.addEventListener('load', setHdr);
    window.addEventListener('resize', setHdr);
    // If your theme toggle changes header height a bit, recalc:
    document.getElementById('theme-toggle')?.addEventListener('click', () => setTimeout(setHdr, 10));

    // --- Utilities ---
    const fmtDate = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    const num = n => (n||0).toLocaleString();

    // --- Load chapters + render one ---
    (async function(){
      const qs = new URLSearchParams(location.search);
      const slug = qs.get('slug');
      const res = await fetch('chapters.json', {cache:'no-store'});
      const data = res.ok ? await res.json() : [];
      data.sort((a,b)=> new Date(a.date)-new Date(b.date));
      let i = data.findIndex(c=>c.slug===slug);
      if (i < 0) i = 0;
      const ch = data[i];

      // Title / crumb / meta
      document.title = ch.title + ' • Moonlight of Montafon';
      document.getElementById('title').textContent = ch.title;
      document.getElementById('crumb').textContent = ch.title;
      document.getElementById('pubDate').textContent = fmtDate(ch.date);
      document.getElementById('readTime').textContent = '~' + (ch.readTime || Math.max(1, Math.round((ch.words||0)/230))) + ' minutes';
      document.getElementById('wordCount').textContent = num(ch.words) + ' words';
      document.getElementById('year').textContent = new Date().getFullYear();

      // HERO (this is what was missing)
      if (ch.hero) {
        const fig = document.getElementById('hero');
        const img = document.getElementById('heroImg');
        img.src = ch.hero;
        img.alt = ch.title;
        img.loading = 'lazy';
        img.decoding = 'async';
        const cap = document.getElementById('heroCap');
        cap.textContent = ch.caption || '';
        fig.hidden = false;
      }

      // Content fragment
      const htmlResp = await fetch(ch.contentHtml, {cache:'no-store'});
      const html = htmlResp.ok ? await htmlResp.text() : '<p>Chapter content coming soon.</p>';
      document.getElementById('content').innerHTML = html;

      // Prev / Next
      const prev = data[i-1], next = data[i+1];
      const prevEl = document.getElementById('prev'), nextEl = document.getElementById('next');
      if (prev) { prevEl.href = prev.href || ('chapter.html?slug='+encodeURIComponent(prev.slug)); prevEl.innerHTML = '<i class="fas fa-arrow-left"></i> ' + prev.title; }
      else { prevEl.href = 'index.html'; prevEl.textContent = '← Home'; }
      if (next) { nextEl.href = next.href || ('chapter.html?slug='+encodeURIComponent(next.slug)); nextEl.innerHTML = next.title + ' <i class="fas fa-arrow-right"></i>'; }
      else { nextEl.href = 'index.html'; nextEl.textContent = 'Index →'; }

      // After images load, correct header offset once more
      window.addEventListener('load', setHdr);
      setHdr();
    })();
  </script>
</body>
</html>
