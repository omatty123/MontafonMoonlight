<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chapters • Moonlight of Montafon</title>

  <!-- Fonts / Tailwind / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"/>

  <!-- Optional global tokens (works with your assets/theme.css if present) -->
  <link rel="stylesheet" href="assets/theme.css"/>

  <style>
    /* Fallback tokens if theme.css is missing */
    :root{
      --bg:#ffffff; --text:#111827;
      --muted:#64748b; --card:#f8fafc; --border:#e5e7eb; --link:#1f47c7;
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --text:#e5e7eb;
      --muted:#94a3b8; --card:#111827; --border:#243244; --link:#8ab4ff;
    }
    html,body{ background:var(--bg); color:var(--text); }
    a{ color:var(--link); }
    body, h1, h2, h3, h4, h5, h6, p, a, span, li, nav, div { font-family:'Inter',sans-serif !important; }

    header.stickybar{
      position:sticky; top:0; z-index:40;
      background:var(--bg); border-bottom:1px solid var(--border);
    }

    .row{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:.75rem;
      padding:1rem 1.25rem;
      display:flex; gap:1rem; align-items:center; justify-content:space-between;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .row:hover{ transform:translateY(-1px); box-shadow:0 10px 25px rgba(0,0,0,.10); }
    .badge{
      min-width:3.25rem; text-align:center;
      font-weight:700; border-radius:9999px; padding:.25rem .5rem;
      background:#2563eb; color:#fff;
    }
    .meta{ color:var(--muted); }
    .gridish{ display:grid; gap:1rem; grid-template-columns:1fr; }
    @media(min-width:640px){ .gridish{ grid-template-columns:1fr; } }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="stickybar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div>
        <h1 class="font-bold text-2xl" style="color:#3b82f6;">
          <i class="fas fa-book mr-2"></i>
          <a href="index.html" class="hover:underline" style="color:#3b82f6;">Moonlight of Montafon</a>
        </h1>
        <p class="text-sm" style="color:var(--muted);">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border" style="color:var(--muted); border-color:var(--border);" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>

  <!-- Title -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-10 pb-4">
    <h2 class="text-3xl font-bold mb-2">All Chapters</h2>
    <p class="meta">Chronological order • #1 is the first installment</p>
  </section>

  <!-- Filter -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-4">
    <div class="flex gap-3 items-center">
      <input id="q" type="search" placeholder="Filter by title…" class="w-full sm:w-96 border rounded px-3 py-2" style="border-color:var(--border); background:var(--bg); color:var(--text);" />
      <button id="clear" class="px-3 py-2 border rounded" style="border-color:var(--border); color:var(--muted);">Clear</button>
    </div>
  </section>

  <!-- List -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <div id="list" class="gridish"></div>
  </main>

  <script>
    /* THEME — same as index/chapter */
    (function () {
      const STORAGE_KEY = "theme";
      const root = document.documentElement;
      const btn  = document.getElementById("theme-toggle");

      function apply(theme){
        if(theme==="dark") root.setAttribute("data-theme","dark");
        else root.removeAttribute("data-theme");
      }
      function initial(){
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved==="dark" || saved==="light") return saved;
        return matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      }
      function reflect(theme){
        if(!btn) return;
        btn.setAttribute("aria-pressed", theme==="dark" ? "true" : "false");
        btn.title = theme==="dark" ? "Switch to light mode" : "Switch to dark mode";
        const icon = btn.querySelector("i");
        if(icon){ icon.className = theme==="dark" ? "fas fa-sun" : "fas fa-moon"; }
      }

      let current = initial(); apply(current); reflect(current);
      matchMedia("(prefers-color-scheme: dark)").addEventListener?.("change", e=>{
        if(localStorage.getItem(STORAGE_KEY)) return;
        current = e.matches ? "dark" : "light"; apply(current); reflect(current);
      });
      btn?.addEventListener("click", ()=>{
        current = current==="dark" ? "light" : "dark";
        localStorage.setItem(STORAGE_KEY, current);
        apply(current); reflect(current);
      });
    })();

    /* DATA + RENDER */
    async function loadChapters(){
      try{
        const r = await fetch('chapters.json',{cache:'no-store'});
        return r.ok ? r.json() : [];
      }catch(e){ return []; }
    }
    const fmt = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const commas = n => (n||0).toLocaleString();

    function row(c, idx){
      const href = c.href || `chapter.html?slug=${encodeURIComponent(c.slug)}`;
      const k   = c.koreanLink ? `<a href="${c.koreanLink}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 hover:underline"><i class="fas fa-globe-asia"></i><span>Korean</span></a>` : '';
      const n   = idx + 1; // installment number
      return `
        <article class="row">
          <div class="flex items-center gap-3 min-w-0">
            <span class="badge">#${n}</span>
            <div class="min-w-0">
              <h3 class="font-semibold text-lg truncate">
                <a href="${href}" class="hover:underline">${c.title}</a>
              </h3>
              <p class="meta text-sm">
                <i class="fas fa-calendar mr-1"></i>${fmt(c.date)}
                <span class="mx-2">•</span>
                <i class="fas fa-clock mr-1"></i>~${c.readTime} min
                <span class="mx-2">•</span>
                <i class="fas fa-eye mr-1"></i>${commas(c.words)} words
              </p>
            </div>
          </div>
          <div class="flex items-center gap-4 flex-shrink-0">
            ${k}
            <a href="${href}" class="inline-flex items-center gap-1 hover:underline"><span>Read</span><i class="fas fa-arrow-right"></i></a>
          </div>
        </article>
      `;
    }

    (async function init(){
      const listEl = document.getElementById('list');
      const qEl    = document.getElementById('q');
      const clear  = document.getElementById('clear');

      const data = await loadChapters();
      // Oldest first so #1 is the very first installment
      data.sort((a,b)=> new Date(a.date) - new Date(b.date));
      const pubs = data.filter(c => (c.status || 'published') === 'published');

      function render(filterText=''){
        const ft = filterText.trim().toLowerCase();
        const filtered = ft ? pubs.filter(c => (c.title||'').toLowerCase().includes(ft)) : pubs;
        listEl.innerHTML = filtered.map((c,i)=> row(c, i)).join('') || `<p class="meta">No chapters found.</p>`;
      }

      render();
      qEl.addEventListener('input', e=> render(e.target.value));
      clear.addEventListener('click', ()=>{ qEl.value=''; render(''); qEl.focus(); });
    })();
  </script>
</body>
</html>
