<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chapter • Moonlight of Montafon</title>

  <!-- Reuse exactly the same font as the landing page -->
  <link rel="stylesheet" href="assets/fonts.css">
  <!-- Your existing Tailwind / FA (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"/>

  <!-- Chapter layout + Google‑Docs normalization -->
  <link rel="stylesheet" href="assets/chapter.css">
</head>
<body>

  <!-- Same header look/feel as index (minimal version) -->
  <header class="border-b" style="border-color:#e5e7eb;">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="brand text-2xl font-extrabold text-blue-600">Moonlight of Montafon</div>
          <div class="subhead text-sm text-gray-500">Translated from Korean • Updates weekly</div>
        </div>
        <button id="theme-toggle" class="p-2 rounded text-gray-500 hover:text-gray-700" aria-label="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="chapter-wrap">
    <!-- Breadcrumb -->
    <nav class="breadcrumb text-sm text-gray-500 mb-2">
      <a href="index.html" class="hover:underline text-blue-700">Home</a>
      <span class="mx-2">›</span>
      <span id="crumb">Chapter</span>
    </nav>

    <!-- Title + meta -->
    <h1 id="title" class="chapter-title">Loading…</h1>
    <div class="meta">
      <span><i class="far fa-calendar-alt mr-1"></i><time id="pubDate">—</time></span>
      <span><i class="far fa-clock mr-1"></i><span id="readTime">—</span></span>
      <span><i class="far fa-eye mr-1"></i><span id="wordCount">—</span></span>
    </div>

    <hr class="page"/>

    <!-- Where the Google‑Docs HTML fragment is injected -->
    <article id="content" class="gdoc"></article>

    <!-- Prev / Next -->
    <nav class="nav-row">
      <a id="prevLink" href="index.html">← Home</a>
      <a id="nextLink" href="index.html">Index →</a>
    </nav>
  </main>

  <script>
  /* Theme toggle (simple) */
  (function(){
    const root=document.documentElement, btn=document.getElementById('theme-toggle');
    const saved=localStorage.getItem('theme')||'light';
    if(saved==='dark') root.dataset.theme='dark';
    btn.addEventListener('click',()=>{
      const next = root.dataset.theme==='dark' ? 'light' : 'dark';
      if(next==='dark') root.dataset.theme='dark'; else delete root.dataset.theme;
      localStorage.setItem('theme', next);
    });
  })();

  const fmtLong = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
  const comma = n => (n||0).toLocaleString();

  async function loadJson(url){ const r=await fetch(url,{cache:'no-store'}); return r.ok ? r.json() : []; }
  async function loadText(url){ const r=await fetch(url,{cache:'no-store'}); return r.ok ? r.text() : ''; }

  /* Normalize messy Google‑Docs HTML after insertion */
  function normalizeGDoc(root){
    // 1) Keep italics/bold by converting styled spans to semantic tags
    root.querySelectorAll('[style*="italic"]').forEach(el=>{
      const em = document.createElement('em'); em.innerHTML = el.innerHTML; el.replaceWith(em);
    });
    root.querySelectorAll('[style*="font-weight:700"],[style*="bold"]').forEach(el=>{
      const strong = document.createElement('strong'); strong.innerHTML = el.innerHTML; el.replaceWith(strong);
    });

    // 2) Strip inline font/size/line-height/margins/whitespace/color so our CSS controls rhythm
    root.querySelectorAll('[style]').forEach(el=>{
      let s=el.getAttribute('style');
      s = s
        .replace(/font-family:[^;]+;?/gi,'')
        .replace(/font-size:[^;]+;?/gi,'')
        .replace(/line-height:[^;]+;?/gi,'')
        .replace(/white-space:[^;]+;?/gi,'')
        .replace(/margin(-top|-bottom|-left|-right)?:[^;]+;?/gi,'')
        .replace(/color:[^;]+;?/gi,'');
      s = s.trim();
      if(s) el.setAttribute('style', s); else el.removeAttribute('style');
    });

    // 3) Remove empty paragraphs (including those with only &nbsp; or <br>)
    root.querySelectorAll('p').forEach(p=>{
      const onlyBr = p.children.length===1 && p.firstElementChild.tagName==='BR';
      const text = (p.textContent||'').replace(/\u00a0/g,'').trim();
      if(!text && !p.querySelector('img') || onlyBr) p.remove();
    });
  }

  (async function(){
    const data = await loadJson('chapters.json');
    data.sort((a,b)=> new Date(a.date)-new Date(b.date)); // ascending 1→2→3

    const slug = new URLSearchParams(location.search).get('slug');
    let idx = data.findIndex(c=>c.slug===slug);
    if(idx<0) idx=0;
    const ch = data[idx];

    // Header text
    document.getElementById('title').textContent = ch.title;
    document.getElementById('crumb').textContent = ch.title;
    document.getElementById('pubDate').textContent = fmtLong(ch.date);
    document.getElementById('readTime').textContent = `~${ch.readTime||6} minutes`;
    document.getElementById('wordCount').textContent = `${comma(ch.words||0)} words`;
    document.title = `${ch.title} • Moonlight of Montafon`;

    // Prev/Next
    const prev = data[idx-1], next = data[idx+1];
    const prevEl = document.getElementById('prevLink'), nextEl = document.getElementById('nextLink');
    if(prev){ prevEl.href = prev.href || ('chapter.html?slug='+encodeURIComponent(prev.slug)); prevEl.textContent = '← ' + prev.title; }
    if(next){ nextEl.href = next.href || ('chapter.html?slug='+encodeURIComponent(next.slug)); nextEl.textContent = next.title + ' →'; }

    // Load the chapter fragment and normalize
    const html = await loadText(ch.contentHtml);
    const mount = document.getElementById('content');
    mount.innerHTML = html;
    normalizeGDoc(mount);
  })();
  </script>
</body>
</html>
