<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chapter • Montafon Moonlight</title>

  <!-- Fonts / Tailwind / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <style>
    :root{ --bg:#ffffff; --text:#111827; --muted:#64748b; --card:#f8fafc; --border:#e5e7eb; --link:#2563eb; }
    html[data-theme="dark"]{ --bg:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --card:#111827; --border:#243244; --link:#8ab4ff; }
    html,body{ background:var(--bg); color:var(--text); }
    a{ color:var(--link); text-decoration:none; } a:hover{ text-decoration:underline; }
    body,h1,h2,h3,h4,h5,h6,p,a,span,li,nav,div,small,button{ font-family:'Inter',sans-serif!important; }

    header.stickybar{ position:sticky; top:0; z-index:40; background:var(--bg); border-bottom:1px solid var(--border); }
    .chapter-wrap{ max-width:820px; margin:0 auto; padding:1.25rem; }
    .meta{ color:var(--muted); }
    .chapter-title{ font-size:1.875rem; font-weight:700; margin-bottom:.5rem; }
    .gdoc p{ margin:1em 0; line-height:1.75; }
    .gdoc em,.gdoc i{ font-style:italic; }

    #heroBlock[hidden]{ display:none; }
    #heroImg{ max-width:min(680px,100%)!important; width:auto!important; height:auto!important; display:block!important; margin:1.25rem auto .5rem!important; border-radius:8px!important; }
    #heroCaption{ color:var(--muted); font-size:.875rem; text-align:center; }

    #contentRoot img, #contentRoot figure img, #contentRoot * img{
      max-width:min(680px,100%)!important; width:auto!important; height:auto!important;
      display:block!important; margin:1.5rem auto!important; border-radius:6px!important;
    }

    .progress-rail{ height:4px; background:#e5e7eb; }
    html[data-theme="dark"] .progress-rail{ background:#1f2937; }
    #progress{ height:4px; background:#3b82f6; width:0%; transition:width .2s linear; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="stickybar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="min-w-0">
        <h1 class="font-bold text-2xl" style="color:#2563eb;">
          <i class="fas fa-book mr-2"></i>
          <a href="index.html" class="hover:underline" style="color:#2563eb;">Montafon Moonlight</a>
        </h1>
        <p class="text-sm meta">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border meta" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
    <div class="progress-rail"><div id="progress"></div></div>
  </header>

  <!-- Main -->
  <main class="chapter-wrap">
    <nav class="text-sm meta mb-3" aria-label="Breadcrumb">
      <a href="index.html" class="hover:underline">Home</a> <span aria-hidden="true">›</span>
      <span id="crumbTitle">Chapter</span>
    </nav>

    <header class="mb-3">
      <h2 id="chapterTitle" class="chapter-title">Loading…</h2>
      <div class="text-sm meta flex flex-wrap gap-x-4 gap-y-2 items-center">
        <span><i class="fas fa-calendar mr-1"></i><time id="pubDate" datetime="">—</time></span>
        <span id="koLinkWrap" class="hidden">
          <span class="mx-2">·</span>
          <a id="koLink" href="#" target="_blank" rel="noopener" class="hover:underline">
            <i class="fas fa-link mr-1"></i> Korean original
          </a>
        </span>
      </div>
    </header>

    <figure id="heroBlock" hidden class="mb-6">
      <img id="heroImg" src="" alt="Chapter image">
      <figcaption id="heroCaption"></figcaption>
    </figure>

    <article id="contentRoot" class="gdoc"></article>

    <nav class="mt-10 flex items-center justify-between text-sm">
      <a id="prevLink" href="index.html" class="hover:underline"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="hover:underline">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>

    <footer class="border-t mt-10 pt-5" style="border-color:var(--border);">
      <p class="text-center text-sm meta">Translation © <span id="copyYear"></span></p>
    </footer>
  </main>

  <script>
    /* THEME toggle */
    (function(){
      const KEY="theme", root=document.documentElement, btn=document.getElementById("theme-toggle");
      function apply(t){ t==="dark" ? root.setAttribute("data-theme","dark") : root.removeAttribute("data-theme"); }
      function initial(){ const s=localStorage.getItem(KEY); if(s==="dark"||s==="light") return s; return matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"; }
      function reflect(t){ if(!btn) return; btn.setAttribute("aria-pressed",t==="dark"?"true":"false"); const i=btn.querySelector("i"); i.className = t==="dark"?"fas fa-sun":"fas fa-moon"; }
      let cur=initial(); apply(cur); reflect(cur);
      btn?.addEventListener("click", ()=>{ cur=cur==="dark"?"light":"dark"; localStorage.setItem(KEY,cur); apply(cur); reflect(cur); });
    })();

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShodvcx1LsVfE8QxCG_RKmxM7c3OsfiMu8haHvS_aQP04CcPHG5agamy3icE8DT2QPM78SEaq3vb1W/pub?gid=0&single=true&output=csv";

    async function loadCSV(url){
      const res = await fetch(url + "&_=" + Date.now());
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      if(lines.length < 2) return [];
      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
      return lines.slice(1).map(row => {
        const cols = row.split(",");
        let obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
        return obj;
      }).filter(ch => ch.title && ch.slug);
    }

    async function loadHtml(url){ 
      try{ 
        const r=await fetch(url+(url.includes("?")?"&":"?")+"v="+Date.now(),{cache:"no-store"}); 
        return r.ok ? (await r.text()) : ""; 
      }catch(e){ return ""; } 
    }

    function extractBody(html){ const m = html.match(/<body[^>]*>([\\s\\S]*?)<\\/body>/i); return m && m[1] ? m[1] : html; }
    function normalizeImages(scope){ scope.querySelectorAll("img").forEach(img=>{ img.removeAttribute("width"); img.removeAttribute("height"); img.loading = img.loading || "lazy"; }); }

    (async function main(){
      document.getElementById("copyYear").textContent = new Date().getFullYear();

      const list = await loadCSV(SHEET_URL);
      list.sort((a,b)=> new Date(a.date) - new Date(b.date));

      const slug = new URLSearchParams(location.search).get("slug");
      let idx = list.findIndex(c=>c.slug===slug);
      if(idx<0) idx=0;
      const ch = list[idx] || {};

      // Title
      if(ch.slug === "cheonmaneyo"){
        document.getElementById("chapterTitle").innerHTML = "“<em>Cheonmaneyo</em>”";
        document.getElementById("crumbTitle").innerHTML = "“<em>Cheonmaneyo</em>”";
      } else {
        document.getElementById("chapterTitle").textContent = ch.title || "Chapter";
        document.getElementById("crumbTitle").textContent = ch.title || "Chapter";
      }

      // Date
      if(ch.date){
        const d = new Date(ch.date);
        const el = document.getElementById("pubDate");
        el.dateTime = d.toISOString().slice(0,10);
        el.textContent = d.toLocaleDateString(undefined,{year:"numeric",month:"long",day:"numeric"});
      }

      // Korean link
      if(ch["korean link"]){
        const wrap=document.getElementById("koLinkWrap");
        const a=document.getElementById("koLink");
        a.href = ch["korean link"];
        wrap.classList.remove("hidden");
      }

      // Hero image (if you add a column later)
      if(ch.hero){
        const fig=document.getElementById("heroBlock");
        fig.hidden=false;
        document.getElementById("heroImg").src=ch.hero;
        document.getElementById("heroCaption").textContent = ch.caption || "";
      }

      // Content
      let html="";
      if(ch.contenthtml) html = await loadHtml(ch.contenthtml);
      html = extractBody(html);
      const root = document.getElementById("contentRoot");
      root.innerHTML = html || "<p>Chapter content coming soon.</p>";
      normalizeImages(root);

      // Prev/Next
      const prev=list[idx-1], next=list[idx+1];
      const prevEl=document.getElementById("prevLink");
      const nextEl=document.getElementById("nextLink");
      if(prev){ prevEl.href="chapter.html?slug="+encodeURIComponent(prev.slug); prevEl.innerHTML = `<i class="fas fa-arrow-left mr-2"></i>${prev.title}`; }
      else { prevEl.href="index.html"; prevEl.innerHTML=`<i class="fas fa-arrow-left mr-2"></i>Home`; }
      if(next){ nextEl.href="chapter.html?slug="+encodeURIComponent(next.slug); nextEl.innerHTML = `${next.title}<i class="fas fa-arrow-right ml-2"></i>`; }
      else { nextEl.href="index.html"; nextEl.innerHTML=`Index<i class="fas fa-arrow-right ml-2"></i>`; }

      // Progress bar
      const bar=document.getElementById("progress");
      function up(){ const s=document.documentElement.scrollTop||document.body.scrollTop; const h=(document.documentElement.scrollHeight-document.documentElement.clientHeight)||1; bar.style.width = Math.round(s/h*100) + "%"; }
      window.addEventListener("scroll", up, {passive:true}); up();
    })();
  </script>
</body>
</html>
