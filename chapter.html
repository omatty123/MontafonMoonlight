<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chapter • Moonlight of Montafon</title>

  <!-- Fonts / Tailwind / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <style>
    /* Theme tokens (match index) */
    :root{
      --bg:#ffffff; --text:#111827;
      --muted:#64748b; --card:#f8fafc; --border:#e5e7eb; --link:#2563eb;
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --text:#e5e7eb;
      --muted:#94a3b8; --card:#111827; --border:#243244; --link:#8ab4ff;
    }
    html,body{ background:var(--bg); color:var(--text); }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Global Inter like landing page */
    body,h1,h2,h3,h4,h5,h6,p,a,span,li,nav,div,small,button{
      font-family:'Inter',sans-serif!important;
    }

    /* Sticky header */
    header.stickybar{
      position:sticky; top:0; z-index:40;
      background:var(--bg); border-bottom:1px solid var(--border);
    }

    /* Layout + text */
    .chapter-wrap{ max-width:820px; margin:0 auto; padding:1.25rem; }
    .meta{ color:var(--muted); }
    .chapter-title{ font-size:1.875rem; font-weight:700; margin-bottom:.5rem; }
    .gdoc p{ margin:1em 0; line-height:1.75; }
    .gdoc em,.gdoc i{ font-style:italic; }

    /* HERO image (optional, from chapters.json "hero") */
    #heroBlock[hidden]{ display:none; }
    #heroImg{
      /* cap hero the same as body images and center */
      max-width:min(680px,100%) !important;
      width:auto !important;
      height:auto !important;
      display:block !important;
      margin:1.25rem auto .5rem !important;
      border-radius:8px !important;
    }
    #heroCaption{ color:var(--muted); font-size:.875rem; text-align:center; }

    /* FORCE medium size for ANY images inside loaded chapter content */
    #contentRoot img,
    #contentRoot figure img,
    #contentRoot * img{
      max-width:min(680px,100%) !important;
      width:auto !important;
      height:auto !important;
      display:block !important;
      margin:1.5rem auto !important;
      border-radius:6px !important;
    }

    /* Progress bar */
    .progress-rail{ height:4px; background:#e5e7eb; }
    html[data-theme="dark"] .progress-rail{ background:#1f2937; }
    #progress{ height:4px; background:#3b82f6; width:0%; transition:width .2s linear; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="stickybar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="min-w-0">
        <h1 class="font-bold text-2xl" style="color:#2563eb;">
          <i class="fas fa-book mr-2"></i>
          <a href="index.html" class="hover:underline" style="color:#2563eb;">Moonlight of Montafon</a>
        </h1>
        <p class="text-sm meta">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border meta" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
    <div class="progress-rail"><div id="progress"></div></div>
  </header>

  <!-- Main -->
  <main class="chapter-wrap">
    <!-- Breadcrumb -->
    <nav class="text-sm meta mb-3" aria-label="Breadcrumb">
      <a href="index.html" class="hover:underline">Home</a> <span aria-hidden="true">›</span>
      <span id="crumbTitle">Chapter</span>
    </nav>

    <!-- Title + meta -->
    <header class="mb-3">
      <h2 id="chapterTitle" class="chapter-title">Loading…</h2>
      <div class="text-sm meta flex flex-wrap gap-x-4 gap-y-2 items-center">
        <span><i class="fas fa-calendar mr-1"></i><time id="pubDate" datetime="">—</time></span>
        <span><i class="fas fa-clock mr-1"></i><span id="readTime">—</span></span>
        <span><i class="fas fa-eye mr-1"></i><span id="wordCount">—</span></span>
        <span id="koLinkWrap" class="hidden">
          <span class="mx-2">·</span>
          <a id="koLink" href="#" target="_blank" rel="noopener" class="hover:underline">
            <i class="fas fa-link mr-1"></i> Korean original
          </a>
        </span>
      </div>
    </header>

    <!-- Optional hero -->
    <figure id="heroBlock" hidden class="mb-6">
      <img id="heroImg" src="" alt="Chapter image">
      <figcaption id="heroCaption"></figcaption>
    </figure>

    <!-- Chapter body gets injected here -->
    <article id="contentRoot" class="gdoc"></article>

    <!-- Prev / Next -->
    <nav class="mt-10 flex items-center justify-between text-sm">
      <a id="prevLink" href="index.html" class="hover:underline"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="hover:underline">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>

    <footer class="border-t mt-10 pt-5" style="border-color:var(--border);">
      <p class="text-center text-sm meta">Translation © <span id="copyYear"></span></p>
    </footer>
  </main>

  <script>
    /* THEME (same as index) */
    (function(){
      const KEY="theme", root=document.documentElement, btn=document.getElementById("theme-toggle");
      function apply(t){ t==="dark" ? root.setAttribute("data-theme","dark") : root.removeAttribute("data-theme"); }
      function initial(){ const s=localStorage.getItem(KEY); if(s==="dark"||s==="light") return s; return matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"; }
      function reflect(t){ if(!btn) return; btn.setAttribute("aria-pressed",t==="dark"?"true":"false"); const i=btn.querySelector("i"); if(i) i.className = t==="dark"?"fas fa-sun":"fas fa-moon"; }
      let cur=initial(); apply(cur); reflect(cur);
      matchMedia("(prefers-color-scheme: dark)").addEventListener?.("change", e=>{ if(localStorage.getItem(KEY)) return; cur=e.matches?"dark":"light"; apply(cur); reflect(cur); });
      btn?.addEventListener("click", ()=>{ cur=cur==="dark"?"light":"dark"; localStorage.setItem(KEY,cur); apply(cur); reflect(cur); });
    })();

    // Helpers
    const fmtLong = (d)=> new Date(d).toLocaleDateString(undefined,{year:"numeric",month:"long",day:"numeric"});
    const num = (n)=> (n||0).toLocaleString();
    async function loadChapters(){ try{ const r=await fetch("chapters.json",{cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); }catch(e){ return []; } }
    async function loadHtml(url){ try{ const r=await fetch(url,{cache:"no-store"}); return r.ok ? (await r.text()) : ""; }catch(e){ return ""; } }

    // Return only the body content if a full HTML doc was pasted/exported
    function extractBody(html){
      const m = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      return m && m[1] ? m[1] : html;
    }

    // Remove width/height/max-width/max-height from images AND their simple wrappers
    function normalizeImages(scope){
      const killSize = (node)=>{
        if(!node) return;
        // Remove width/height attributes
        node.removeAttribute?.("width"); node.removeAttribute?.("height");
        // Clean inline style
        const st = node.getAttribute?.("style");
        if(st){
          const cleaned = st
            .replace(/(?:^|;)\s*(max-)?width\s*:[^;]*;?/gi,"")
            .replace(/(?:^|;)\s*(max-)?height\s*:[^;]*;?/gi,"");
          if(cleaned.trim()) node.setAttribute("style", cleaned); else node.removeAttribute("style");
        }
      };

      scope.querySelectorAll("img").forEach(img=>{
        // Image itself
        killSize(img);
        img.loading = img.loading || "lazy";

        // If the parent only wraps the image (and maybe a caption <br>), nuke its sizing too
        const p = img.parentElement;
        if(p && !p.querySelector("img:not(:first-child)")){
          killSize(p);
        }
        // Also try grandparent if it's a simple figure-like wrapper
        const gp = p?.parentElement;
        if(gp && gp.tagName.match(/^(FIGURE|DIV|P)$/) && gp.querySelectorAll("img").length===1){
          killSize(gp);
        }
      });
    }

    (async function main(){
      document.getElementById("copyYear").textContent = new Date().getFullYear();

      const list = await loadChapters();
      list.sort((a,b)=> new Date(a.date) - new Date(b.date)); // oldest → newest

      const slug = new URLSearchParams(location.search).get("slug");
      let idx = list.findIndex(c=>c.slug===slug);
      if(idx<0) idx=0;
      const ch = list[idx] || {};

      // Title + meta
      document.getElementById("chapterTitle").textContent = ch.title || "Chapter";
      document.getElementById("crumbTitle").textContent = ch.title || "Chapter";
      if(ch.date){
        const d = new Date(ch.date);
        const el = document.getElementById("pubDate");
        el.dateTime = d.toISOString().slice(0,10);
        el.textContent = fmtLong(ch.date);
      }
      document.getElementById("readTime").textContent = ch.readTime ? `~${ch.readTime} minutes` : "—";
      document.getElementById("wordCount").textContent = ch.words ? `${num(ch.words)} words` : "—";

      // Korean original link
      if(ch.koreanLink){
        const wrap=document.getElementById("koLinkWrap");
        const a=document.getElementById("koLink");
        a.href = ch.koreanLink;
        wrap.classList.remove("hidden");
      }

      // Hero
      if(ch.hero){
        const fig=document.getElementById("heroBlock");
        fig.hidden=false;
        const hero=document.getElementById("heroImg");
        hero.src=ch.hero;
        document.getElementById("heroCaption").textContent = ch.caption || "";
      }

      // Load body
      let html="";
      if(ch.contentHtml) html = await loadHtml(ch.contentHtml);
      html = extractBody(html);
      const root = document.getElementById("contentRoot");
      root.innerHTML = html || "<p>Chapter content coming soon.</p>";

      // Normalize image sizing AFTER inject
      normalizeImages(root);

      // Prev/Next
      const prev=list[idx-1], next=list[idx+1];
      const prevEl=document.getElementById("prevLink");
      const nextEl=document.getElementById("nextLink");
      if(prev){ prevEl.href = prev.href || ("chapter.html?slug="+encodeURIComponent(prev.slug)); prevEl.innerHTML = `<i class="fas fa-arrow-left mr-2"></i>${prev.title}`; }
      else { prevEl.href="index.html"; prevEl.innerHTML=`<i class="fas fa-arrow-left mr-2"></i>Home`; }
      if(next){ nextEl.href = next.href || ("chapter.html?slug="+encodeURIComponent(next.slug)); nextEl.innerHTML = `${next.title}<i class="fas fa-arrow-right ml-2"></i>`; }
      else { nextEl.href="index.html"; nextEl.innerHTML=`Index<i class="fas fa-arrow-right ml-2"></i>`; }

      // Reading progress
      const bar=document.getElementById("progress");
      function up(){
        const s=document.documentElement.scrollTop||document.body.scrollTop;
        const h=(document.documentElement.scrollHeight-document.documentElement.clientHeight)||1;
        bar.style.width = Math.round(s/h*100) + "%";
      }
      window.addEventListener("scroll", up, {passive:true}); up();
    })();
  </script>
</body>
</html>
