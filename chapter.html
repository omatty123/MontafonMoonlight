<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chapter • Moonlight of Montafon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 0) Apply saved theme BEFORE paint (no flash) -->
  <script>
    (function(){
      var saved = localStorage.getItem('theme');
      if(saved === 'dark'){ document.documentElement.setAttribute('data-theme','dark'); }
    })();
  </script>

  <!-- 1) Fonts match index (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- 2) Tailwind + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <!-- 3) Your theme tokens (colors + image sizing) -->
  <link rel="stylesheet" href="assets/theme.css">

  <!-- 4) Minimal local styles (fonts + small helpers) -->
  <style>
    /* Match landing page font everywhere */
    html, body, h1,h2,h3,h4,h5,h6, p, a, span, li, nav, div { font-family: 'Inter', sans-serif; }

    /* Layout */
    .container { max-width: 64rem; } /* ~1024px */
    .meta { color: var(--muted); }
    .chapter-title { color: var(--text); }

    /* Fallback (if theme.css not loaded) to keep pasted images sane */
    .gdoc img{
      max-width: 680px; width: 100%; height: auto;
      display: block; margin: 1.5rem auto; border-radius: 6px;
    }
  </style>
</head>
<body>

  <!-- Header (same look/feel as index) -->
  <header class="sticky top-0 z-40 bg-white border-b border-gray-200" style="background:var(--bg); border-color:var(--border);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div>
        <h1 class="font-bold text-2xl" style="color:var(--link)"><i class="fas fa-book mr-2"></i> Moonlight of Montafon</h1>
        <p class="text-sm" style="color:var(--muted)">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border" style="color:var(--muted); border-color:var(--border)" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4 meta" aria-label="Breadcrumb">
      <a href="index.html" class="hover:underline" style="color:var(--link)">Home</a> <span class="mx-2">›</span>
      <span id="crumbTitle">Chapter</span>
    </nav>

    <!-- Chapter header -->
    <header class="mb-6">
      <h2 id="chapterTitle" class="chapter-title text-3xl font-bold mb-2">Loading…</h2>
      <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm meta">
        <span><i class="fas fa-calendar mr-1"></i><time id="pubDate" datetime="">—</time></span>
        <span><i class="fas fa-clock mr-1"></i><span id="readTime">—</span></span>
        <span><i class="fas fa-eye mr-1"></i><span id="wordCount">—</span></span>
      </div>
    </header>

    <!-- Optional hero -->
    <figure id="heroBlock" class="mb-6" hidden>
      <img id="heroImg" src="" alt="Chapter image" class="w-full rounded-lg shadow" />
      <figcaption id="heroCaption" class="text-xs mt-2 meta"></figcaption>
    </figure>

    <!-- Chapter content (pasted Google Docs HTML goes inside via fetch) -->
    <article id="contentRoot" class="gdoc prose"></article>

    <!-- Prev / Next -->
    <nav class="mt-10 flex items-center justify-between">
      <a id="prevLink" href="index.html" class="text-sm hover:underline" style="color:var(--link)"><i class="fas fa-arrow-left mr-2"></i>Previous</a>
      <a id="nextLink" href="index.html" class="text-sm hover:underline" style="color:var(--link)">Next<i class="fas fa-arrow-right ml-2"></i></a>
    </nav>

    <!-- Footer -->
    <footer class="border-t mt-12 pt-6" style="border-color: var(--border);">
      <div class="text-center">
        <p class="text-sm meta">Translation © <span id="copyrightYear"></span></p>
      </div>
    </footer>
  </main>

  <!-- Scripts -->
  <script>
    // Theme toggle (same logic as index)
    (function(){
      const key='theme', root=document.documentElement;
      function apply(t){ t==='dark' ? root.setAttribute('data-theme','dark')
                                   : root.removeAttribute('data-theme'); }
      let current = (localStorage.getItem(key) === 'dark')
                    ? 'dark'
                    : (localStorage.getItem(key) === 'light'
                       ? 'light'
                       : (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
      apply(current);
      const btn=document.getElementById('theme-toggle');
      if(btn){
        btn.addEventListener('click', ()=>{
          current = current==='dark' ? 'light' : 'dark';
          localStorage.setItem(key,current); apply(current);
        });
      }
    })();

    // Data + rendering
    const fmtLong = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    const num     = n => (n||0).toLocaleString();

    async function loadChapters(){
      try{
        const r = await fetch('chapters.json', {cache:'no-store'});
        if(!r.ok) throw 0;
        return await r.json();
      }catch(e){ return []; }
    }
    async function loadHtml(url){
      try{
        const r = await fetch(url, {cache:'no-store'});
        return r.ok ? (await r.text()) : '';
      }catch(e){ return ''; }
    }

    (async function(){
      document.getElementById('copyrightYear').textContent = new Date().getFullYear();

      const list = await loadChapters();
      list.sort((a,b)=> new Date(a.date)-new Date(b.date)); // ascending 1→2→3

      const p = new URLSearchParams(location.search);
      const slug = p.get('slug');
      let idx = list.findIndex(c=>c.slug===slug);
      if(idx<0) idx=0;
      const ch = list[idx] || {};

      // Header fields
      document.getElementById('chapterTitle').textContent = ch.title || 'Chapter';
      document.getElementById('crumbTitle').textContent   = ch.title || 'Chapter';
      if(ch.date){
        const d = new Date(ch.date);
        const el = document.getElementById('pubDate');
        el.dateTime = d.toISOString().slice(0,10);
        el.textContent = fmtLong(ch.date);
      }
      document.getElementById('readTime').textContent = ch.readTime ? ('~'+ch.readTime+' minutes') : '—';
      document.getElementById('wordCount').textContent = ch.words ? (num(ch.words)+' words') : '—';

      // Hero
      if(ch.hero){
        const f=document.getElementById('heroBlock');
        f.hidden=false;
        document.getElementById('heroImg').src = ch.hero;
        document.getElementById('heroCaption').textContent = ch.caption || '';
      }

      // Content (your pasted Google‑Docs HTML file path in chapters.json -> contentHtml)
      const html = ch.contentHtml ? await loadHtml(ch.contentHtml) : '<p>Chapter content coming soon.</p>';
      document.getElementById('contentRoot').innerHTML = html;

      // Prev/Next links
      const prev = list[idx-1], next = list[idx+1];
      const prevEl = document.getElementById('prevLink');
      const nextEl = document.getElementById('nextLink');
      if(prev){
        prevEl.href = prev.href || ('chapter.html?slug='+encodeURIComponent(prev.slug));
        prevEl.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>'+prev.title;
      }else{
        prevEl.href='index.html'; prevEl.innerHTML='<i class="fas fa-arrow-left mr-2"></i>Home';
      }
      if(next){
        nextEl.href = next.href || ('chapter.html?slug='+encodeURIComponent(next.slug));
        nextEl.innerHTML = next.title+'<i class="fas fa-arrow-right ml-2"></i>';
      }else{
        nextEl.href='index.html'; nextEl.innerHTML='Index<i class="fas fa-arrow-right ml-2"></i>';
      }
    })();
  </script>
</body>
</html>
