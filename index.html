<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Montafon Moonlight</title>

  <!-- Fonts / Tailwind / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />

  <style>
    :root{ --bg:#ffffff; --text:#111827; --muted:#64748b; --card:#f8fafc; --border:#e5e7eb; --link:#2563eb; }
    html[data-theme="dark"]{ --bg:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --card:#111827; --border:#243244; --link:#8ab4ff; }
    html,body{ background:var(--bg); color:var(--text); }
    a{ color:var(--link); text-decoration:none; } a:hover{ text-decoration:underline; }
    body,h1,h2,h3,h4,h5,h6,p,a,span,li,nav,div,small,button{ font-family:'Inter',sans-serif!important; }

    header.stickybar{ position:sticky; top:0; z-index:40; background:var(--bg); border-bottom:1px solid var(--border); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; overflow:hidden; display:flex; flex-direction:column; transition:transform .15s ease; }
    .card:hover{ transform:translateY(-2px); }
    .card img{ width:100%; height:180px; object-fit:cover; }
    .card-content{ padding:1rem; flex:1; display:flex; flex-direction:column; }
    .card-title{ font-weight:600; margin-bottom:.25rem; font-size:1.125rem; }
    .card-summary{ flex:1; font-size:.875rem; color:var(--muted); }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="stickybar">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="min-w-0">
        <h1 class="font-bold text-2xl" style="color:#2563eb;">
          <i class="fas fa-book mr-2"></i> Montafon Moonlight
        </h1>
        <p class="text-sm meta">Translated from Korean • Updates weekly</p>
      </div>
      <button id="theme-toggle" class="p-2 rounded border meta" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold mb-6">Latest chapters</h2>
    <div id="chaptersGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="emptyMsg" class="meta">No chapters yet.</p>
  </main>

  <footer class="border-t mt-10 pt-5 text-center text-sm meta" style="border-color:var(--border);">
    Translation © <span id="copyYear"></span> • <a href="#" class="hover:underline">Support the original author</a>
  </footer>

  <script>
    /* THEME toggle */
    (function(){
      const KEY="theme", root=document.documentElement, btn=document.getElementById("theme-toggle");
      function apply(t){ t==="dark" ? root.setAttribute("data-theme","dark") : root.removeAttribute("data-theme"); }
      function initial(){ const s=localStorage.getItem(KEY); if(s==="dark"||s==="light") return s; return matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"; }
      function reflect(t){ if(!btn) return; btn.setAttribute("aria-pressed",t==="dark"?"true":"false"); const i=btn.querySelector("i"); i.className = t==="dark"?"fas fa-sun":"fas fa-moon"; }
      let cur=initial(); apply(cur); reflect(cur);
      btn?.addEventListener("click", ()=>{ cur=cur==="dark"?"light":"dark"; localStorage.setItem(KEY,cur); apply(cur); reflect(cur); });
    })();

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShodvcx1LsVfE8QxCG_RKmxM7c3OsfiMu8haHvS_aQP04CcPHG5agamy3icE8DT2QPM78SEaq3vb1W/pub?gid=0&single=true&output=csv";

    async function loadCSV(url){
      const res = await fetch(url + "&_=" + Date.now());
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      if(lines.length < 2) return [];
      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
      return lines.slice(1).map(row => {
        const cols = row.split(",");
        let obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
        return obj;
      }).filter(ch => ch.title && ch.slug); // skip empties
    }

    function cardTemplate(ch, idx){
      return `
        <a href="chapter.html?slug=${encodeURIComponent(ch.slug)}" class="card">
          <img src="assets/ch${idx+1}-cover.jpg" alt="">
          <div class="card-content">
            <h3 class="card-title">${ch.title}</h3>
            <p class="card-summary">${ch.summary||""}</p>
            <p class="text-xs meta mt-2"><i class="fas fa-calendar mr-1"></i>${ch.date||""}</p>
          </div>
        </a>
      `;
    }

    (async function(){
      document.getElementById("copyYear").textContent = new Date().getFullYear();
      const list = await loadCSV(SHEET_URL);
      const grid = document.getElementById("chaptersGrid");
      const msg = document.getElementById("emptyMsg");
      if(list.length){
        msg.style.display="none";
        list.forEach((ch,i)=> grid.insertAdjacentHTML("beforeend", cardTemplate(ch,i)));
      }
    })();
  </script>
</body>
</html>
